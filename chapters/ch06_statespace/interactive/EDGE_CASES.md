# エッジケース処理ドキュメント

本ドキュメントは、第6章状態空間表現のインタラクティブツールで実装されているエッジケース処理をまとめたものです。

## 1. 特異行列 (Singular Matrix)

### 検出条件
- `det(A) ≈ 0` (具体的には `|det(A)| < 1e-10`)

### 処理内容
- **状態遷移行列計算タブ**: 警告メッセージを表示
  - "⚠️ A行列は特異行列またはほぼ特異です（det(A) ≈ 0）。計算結果の精度に注意してください。"
- **固有値解析タブ**: 警告メッセージを表示
  - "⚠️ A行列は特異行列またはほぼ特異です（det(A) ≈ 0）。少なくとも1つの固有値が0です。"
- 計算は継続されるが、ユーザーに注意を促す

### 実装箇所
- `calculateStateTransitionMatrix()` 関数
- `analyzeEigenvalues()` 関数

---

## 2. 不安定システム (Unstable System)

### 検出条件
- A行列の固有値の実部が正 (`Re(λᵢ) > 0`)

### 処理内容
- **時間応答シミュレーションタブ**: 警告メッセージを表示
  - "⚠️ システムは不安定です（正の実部を持つ固有値が存在）。応答が発散する可能性があります。"
- **固有値解析タブ**: 不安定判定を表示
  - "✗ システムは**不安定**です（正の実部を持つ固有値が存在）"
- シミュレーション中の数値オーバーフロー検出
  - "⚠️ シミュレーション中に数値オーバーフローが発生しました（t=X.XX秒）。システムが不安定すぎる可能性があります。"

### 実装箇所
- `runSimulation()` 関数（シミュレーション実行前および実行中）
- `analyzeEigenvalues()` 関数

---

## 3. 複素固有値 (Complex Eigenvalues)

### 検出条件
- 固有値の虚部が0でない (`|Im(λᵢ)| > 1e-10`)

### 処理内容
- **時間応答シミュレーションタブ**: 情報メッセージを表示
  - "ℹ️ システムは複素固有値を持ちます。応答に振動成分が含まれます。"
- **固有値解析タブ**:
  - 複素固有値の個数を表示
  - "ℹ️ N個の複素固有値を検出しました。システムは振動的な応答を示します。"
  - モード説明で固有周波数を表示
    - "減衰振動モード（固有周波数: X.XXX rad/s）"
    - "発散振動モード（固有周波数: X.XXX rad/s）"
    - "持続振動モード（固有周波数: X.XXX rad/s）"
- 複素固有値のテーブル表示（実部・虚部・絶対値）
- 複素平面（s平面）上への正確なプロット

### 実装箇所
- `runSimulation()` 関数
- `analyzeEigenvalues()` 関数

---

## 4. 大きな行列 (Large Matrices)

### 検出条件
- 状態数、入力数、または出力数が5以上 (`n >= 5` または `m >= 5` または `p >= 5`)
- 上限: 10×10（それ以上は入力拒否）

### 処理内容
- **状態方程式入力タブ**: 警告メッセージを表示
  - "⚠️ 5×5以上の大きな行列は計算が重くなる可能性があります。教育目的として3×3以下を推奨します。"
- 10×10を超える行列は入力を拒否
  - "エラー: 状態数は1～10の整数を入力してください。"
- 計算は実行されるが、パフォーマンスに注意を促す

### 実装箇所
- `updateMatrixSizes()` 関数

---

## 5. 数値精度とオーバーフロー (Numerical Precision & Overflow)

### 検出条件
- 計算結果に無限大が含まれる (`!isFinite(value)`)
- 計算結果にNaNが含まれる (`isNaN(value)`)

### 処理内容
- **状態遷移行列計算タブ**:
  - NaN検出時: "計算エラー: 数値計算が失敗しました（NaN発生）。行列の値や時刻を確認してください。"
  - 無限大検出時: "⚠️ 計算結果に無限大の値が含まれます。システムが不安定または時刻が大きすぎる可能性があります。"
- **時間応答シミュレーションタブ**:
  - シミュレーション中にオーバーフロー検出時、即座に停止
  - 警告メッセージを表示し、データの欠損を防ぐ
- **Plotly.jsプロット点数制限**:
  - プロット点数を最大10,000点に制限
  - 超過した場合、サンプリング間隔を自動調整
  - "⚠️ サンプリング間隔を調整しました（プロット点数を10000以下に制限）。調整後の間隔: X.XXXX秒"

### 実装箇所
- `calculateStateTransitionMatrix()` 関数
- `runSimulation()` 関数
- `formatMatrix()` 関数（無限大を `\infty` として表示）

---

## 6. 入力バリデーション (Input Validation)

### 検出条件
- 数値以外の入力
- 範囲外の値
- 必須フィールドの空欄

### 処理内容

#### 行列サイズ
- 状態数 (n): 1～10の整数のみ
- 入力数 (m): 1～10の整数のみ
- 出力数 (p): 1～10の整数のみ
- エラー時: デフォルト値に戻して警告表示

#### 時刻入力
- 状態遷移行列計算: t >= 0
- エラー時: "エラー: 時刻は0以上の数値を入力してください。"

#### シミュレーション設定
- シミュレーション時間: tFinal > 0
- サンプリング間隔: 0 < dt < tFinal
- エラー時: 適切なエラーメッセージを表示

#### 初期状態
- 各要素が有効な数値であることを確認
- エラー時: "エラー: 初期状態 xᵢ(0) に有効な数値を入力してください。"

### 実装箇所
- `updateMatrixSizes()` 関数
- `calculateStateTransitionMatrix()` 関数
- `runSimulation()` 関数
- `plotTrajectory()` 関数
- `readMatrix()` 関数

---

## 7. XSS対策 (XSS Prevention)

### 対策内容

#### 入力フィルタリング
- すべての入力を `parseFloat()` で数値に変換
- 数値以外の入力は自動的に0に変換またはエラー表示
- HTMLタグやスクリプトの実行を完全に防止

#### 安全な出力
- LaTeX数式の生成時、数値のみを使用
- `formatMatrix()` 関数で数値検証を実施
- NaNや無限大も安全に処理（LaTeX記法に変換）

#### DOM操作の安全性
- ユーザー入力を直接HTMLに挿入しない
- `innerHTML` の使用は固定テンプレートのみ
- 動的コンテンツは数値計算結果のみ

### 実装箇所
- `readMatrix()` 関数（入力検証）
- `formatMatrix()` 関数（出力検証）
- 全ての入力処理関数

---

## 8. 行列サイズの整合性チェック

### 検出条件
- A行列のサイズが n×n でない
- B行列のサイズが n×m でない
- C行列のサイズが p×n でない
- D行列のサイズが p×m でない

### 処理内容
- 状態方程式表示時にサイズを検証
- エラー時: 該当する行列のエラーメッセージを表示
  - "エラー: X行列のサイズが不正です。"
- 計算を中止し、ユーザーに修正を促す

### 実装箇所
- `displayStateEquations()` 関数

---

## 9. 位相面プロット制限

### 検出条件
- 状態数が2でない (`n !== 2`)

### 処理内容
- 位相面タブで明示的に警告を表示
  - "⚠️ このツールは2×2システムでのみ動作します。タブ1で状態数を2に設定してください。"
- プロット処理を実行せず、安全に終了

### 実装箇所
- `plotTrajectory()` 関数

---

## 10. エラーハンドリング全体構造

### Try-Catch ブロック
以下の関数に包括的なtry-catchを実装:
- `displayStateEquations()`
- `calculateStateTransitionMatrix()`
- `runSimulation()`
- `plotTrajectory()`
- `analyzeEigenvalues()`

### エラーメッセージの構造
1. **エラー種別**: 何が問題か明確に
2. **原因**: 可能性のある原因を提示
3. **対処法**: ユーザーが取るべきアクションを示唆

例: "計算エラー: 数値計算が失敗しました（NaN発生）。行列の値や時刻を確認してください。"

---

## テスト推奨ケース

### 1. 特異行列のテスト
```
A = [[1, 2], [2, 4]]  // det(A) = 0
```

### 2. 不安定システムのテスト
```
A = [[1, 0], [0, 2]]  // 両固有値が正
```

### 3. 複素固有値のテスト
```
A = [[0, -1], [1, 0]]  // 固有値: ±i（純虚数）
A = [[-1, -2], [2, -1]]  // 固有値: -1 ± 2i（減衰振動）
```

### 4. 大きな行列のテスト
- 5×5行列を入力して警告表示を確認
- 11×11行列を入力して拒否されることを確認

### 5. 無効入力のテスト
- 行列要素に文字を入力（自動的に0に変換されることを確認）
- 負の時刻を入力（エラーメッセージを確認）
- シミュレーション時間 < サンプリング間隔（エラーメッセージを確認）

### 6. 数値オーバーフローのテスト
```
A = [[10, 0], [0, 10]]  // 大きな固有値
t = 10  // 長い時間
→ e^(At) が発散し、無限大検出
```

---

## まとめ

本実装では、以下の6つの主要なエッジケースを包括的に処理しています:

1. ✅ **特異行列**: 検出と警告表示
2. ✅ **不安定システム**: 固有値チェックと警告、オーバーフロー検出
3. ✅ **複素固有値**: 正確な処理と振動モード説明
4. ✅ **大きな行列**: サイズ制限と警告
5. ✅ **数値精度**: NaN/無限大検出、プロット点数制限
6. ✅ **入力バリデーション**: 全入力の検証とXSS対策

すべてのエッジケースにおいて、ユーザーに分かりやすいエラーメッセージを提供し、
システムがクラッシュすることなく安全に動作するように設計されています。
