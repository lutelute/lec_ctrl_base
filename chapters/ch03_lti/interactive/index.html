<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第3章 LTIシステムの表現 - インタラクティブ学習ツール</title>

    <!-- KaTeX CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        .tool-section {
            margin-bottom: 30px;
        }

        .tool-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-field input,
        .input-field select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: bold;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .output-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
            min-height: 60px;
        }

        .output-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .math-output {
            font-size: 1.2em;
            color: #333;
            margin: 10px 0;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 15px;
            border-radius: 8px;
            color: #c33;
            margin: 10px 0;
        }

        .success-message {
            background: #efe;
            border-left: 4px solid #4c4;
            padding: 15px;
            border-radius: 8px;
            color: #363;
            margin: 10px 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #1976d2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #667eea;
        }

        .step-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .step-container .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .animation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                min-width: 100%;
            }

            header h1 {
                font-size: 1.5em;
            }

            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>第3章 LTIシステムの表現</h1>
            <p>インタラクティブ学習ツール - Interactive Learning Tool</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('impulse')">インパルス応答可視化</button>
            <button class="tab-button" onclick="showTab('convolution')">畳み込みアニメーション</button>
            <button class="tab-button" onclick="showTab('lti-properties')">LTI特性確認</button>
        </div>

        <!-- Tab 1: Impulse Response Visualization -->
        <div id="impulse-tab" class="tab-content active">
            <div class="tool-section">
                <h2>インパルス応答可視化ツール (Impulse Response Visualization)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> システムのタイプを選択し、パラメータを調整してインパルス応答を確認します。
                    1次遅れ系では時定数、2次遅れ系では固有角周波数と減衰係数を変更できます。
                </div>

                <div class="input-field">
                    <label>システムタイプ (System Type):</label>
                    <select id="system-type" onchange="updateSystemParameters()">
                        <option value="first-order">1次遅れ系 (First-Order System)</option>
                        <option value="second-order">2次遅れ系 (Second-Order System)</option>
                    </select>
                </div>

                <div id="first-order-params" class="parameter-section">
                    <div class="slider-container">
                        <label>時定数 τ (Time Constant): <span class="slider-value" id="tau-value">1.0</span></label>
                        <input type="range" id="tau-slider" min="0.1" max="5" step="0.1" value="1.0" oninput="updateTau()">
                    </div>
                    <div class="output-box">
                        <h3>伝達関数 (Transfer Function)</h3>
                        <div id="first-order-tf" class="math-output"></div>
                    </div>
                </div>

                <div id="second-order-params" class="parameter-section" style="display: none;">
                    <div class="slider-container">
                        <label>固有角周波数 ωₙ (Natural Frequency): <span class="slider-value" id="wn-value">1.0</span></label>
                        <input type="range" id="wn-slider" min="0.5" max="5" step="0.1" value="1.0" oninput="updateWn()">
                    </div>
                    <div class="slider-container">
                        <label>減衰係数 ζ (Damping Ratio): <span class="slider-value" id="zeta-value">0.5</span></label>
                        <input type="range" id="zeta-slider" min="0" max="2" step="0.05" value="0.5" oninput="updateZeta()">
                    </div>
                    <div class="output-box">
                        <h3>伝達関数 (Transfer Function)</h3>
                        <div id="second-order-tf" class="math-output"></div>
                    </div>
                    <div class="info-box" id="damping-info">
                        <strong>減衰状態:</strong> <span id="damping-state">不足減衰 (Underdamped)</span>
                    </div>
                </div>

                <div>
                    <button class="btn" onclick="plotImpulseResponse()">インパルス応答を表示</button>
                    <button class="btn btn-secondary" onclick="plotStepResponse()">ステップ応答も表示</button>
                </div>

                <div class="chart-container">
                    <canvas id="impulseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab 2: Convolution Animation -->
        <div id="convolution-tab" class="tab-content">
            <div class="tool-section">
                <h2>畳み込み積分アニメーション (Convolution Integral Animation)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> 入力信号x(t)とインパルス応答h(t)を選択し、畳み込み y(t) = ∫h(τ)x(t-τ)dτ の過程を視覚化します。
                </div>

                <div class="input-group">
                    <div class="input-field">
                        <label>入力信号 x(t) (Input Signal):</label>
                        <select id="input-signal">
                            <option value="step">単位ステップ (Unit Step)</option>
                            <option value="pulse">矩形パルス (Rectangular Pulse)</option>
                            <option value="ramp">ランプ (Ramp)</option>
                            <option value="exp">指数減衰 (Exponential Decay)</option>
                        </select>
                    </div>
                    <div class="input-field">
                        <label>インパルス応答 h(t) (Impulse Response):</label>
                        <select id="impulse-response">
                            <option value="exp-decay">指数減衰: e^(-t)</option>
                            <option value="exp-decay-fast">急速減衰: e^(-2t)</option>
                            <option value="exp-decay-slow">緩慢減衰: e^(-0.5t)</option>
                        </select>
                    </div>
                </div>

                <div class="animation-controls">
                    <button class="btn" onclick="startConvolution()">アニメーション開始</button>
                    <button class="btn btn-secondary" onclick="pauseConvolution()">一時停止</button>
                    <button class="btn btn-secondary" onclick="resetConvolution()">リセット</button>
                    <div class="slider-container" style="flex: 1; margin: 0;">
                        <label>時刻 t: <span class="slider-value" id="time-value">0.0</span></label>
                        <input type="range" id="time-slider" min="0" max="10" step="0.1" value="0" oninput="updateConvolutionTime()">
                    </div>
                </div>

                <div class="output-box">
                    <h3>畳み込み積分の式 (Convolution Integral Formula)</h3>
                    <div id="convolution-formula" class="math-output"></div>
                </div>

                <div class="grid-2col">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="signalsChart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="convolutionChart"></canvas>
                    </div>
                </div>

                <div class="step-container" id="convolution-explanation">
                    <h3>畳み込みの計算ステップ (Convolution Calculation Steps)</h3>
                    <div class="step">
                        <span class="step-number">1</span>
                        <strong>時間反転 (Time Reversal):</strong> インパルス応答h(τ)を時間反転してh(-τ)を作成します。
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <strong>時間シフト (Time Shift):</strong> h(-τ)を時刻tだけシフトしてh(t-τ)を作成します。
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <strong>積と積分 (Product and Integration):</strong> x(τ)とh(t-τ)を掛け合わせ、τについて積分します。
                    </div>
                    <div class="step">
                        <span class="step-number">4</span>
                        <strong>出力 (Output):</strong> この積分値がy(t)の値となります。
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: LTI System Properties Verification -->
        <div id="lti-properties-tab" class="tab-content">
            <div class="tool-section">
                <h2>LTIシステム特性確認ツール (LTI System Properties Verification)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> 線形性（重ね合わせの原理）と時不変性を数値的に確認できます。
                </div>

                <!-- Linearity Test -->
                <div class="tool-section">
                    <h2>線形性の検証 (Linearity Verification)</h2>

                    <div class="output-box">
                        <h3>重ね合わせの原理 (Superposition Principle)</h3>
                        <div id="linearity-formula" class="math-output"></div>
                    </div>

                    <div class="grid-2col">
                        <div>
                            <h3>入力信号1 (Input 1):</h3>
                            <div class="input-field">
                                <label>振幅 A₁:</label>
                                <input type="number" id="a1" value="2" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>信号タイプ:</label>
                                <select id="signal1-type">
                                    <option value="step">ステップ</option>
                                    <option value="exp">指数減衰</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <h3>入力信号2 (Input 2):</h3>
                            <div class="input-field">
                                <label>振幅 A₂:</label>
                                <input type="number" id="a2" value="3" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>信号タイプ:</label>
                                <select id="signal2-type">
                                    <option value="step">ステップ</option>
                                    <option value="exp" selected>指数減衰</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="input-field">
                        <label>システム (時定数τ):</label>
                        <input type="number" id="linearity-tau" value="1.0" step="0.1">
                    </div>

                    <div>
                        <button class="btn" onclick="verifyLinearity()">線形性を検証</button>
                    </div>

                    <div id="linearity-result" class="output-box" style="display: none;">
                        <h3>検証結果 (Verification Result)</h3>
                        <div id="linearity-result-content"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="linearityChart"></canvas>
                    </div>
                </div>

                <!-- Time Invariance Test -->
                <div class="tool-section">
                    <h2>時不変性の検証 (Time Invariance Verification)</h2>

                    <div class="output-box">
                        <h3>時不変性の定義 (Time Invariance Definition)</h3>
                        <div id="time-invariance-formula" class="math-output"></div>
                    </div>

                    <div class="input-group">
                        <div class="input-field">
                            <label>入力信号:</label>
                            <select id="ti-signal-type">
                                <option value="pulse">矩形パルス</option>
                                <option value="exp">指数減衰</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>時間遅延 T (Time Delay):</label>
                            <input type="number" id="time-delay" value="2" step="0.1">
                        </div>
                        <div class="input-field">
                            <label>システム (時定数τ):</label>
                            <input type="number" id="ti-tau" value="1.0" step="0.1">
                        </div>
                    </div>

                    <div>
                        <button class="btn" onclick="verifyTimeInvariance()">時不変性を検証</button>
                    </div>

                    <div id="ti-result" class="output-box" style="display: none;">
                        <h3>検証結果 (Verification Result)</h3>
                        <div id="ti-result-content"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="timeInvarianceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let impulseChart = null;
        let signalsChart = null;
        let convolutionChart = null;
        let linearityChart = null;
        let timeInvarianceChart = null;
        let convolutionAnimationId = null;
        let currentTime = 0;
        let isAnimating = false;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ]
            });
        }

        // Tab 1: Impulse Response Functions
        function updateSystemParameters() {
            const systemType = document.getElementById('system-type').value;

            if (systemType === 'first-order') {
                document.getElementById('first-order-params').style.display = 'block';
                document.getElementById('second-order-params').style.display = 'none';
                updateTau();
            } else {
                document.getElementById('first-order-params').style.display = 'none';
                document.getElementById('second-order-params').style.display = 'block';
                updateWn();
                updateZeta();
            }
        }

        function updateTau() {
            const tau = parseFloat(document.getElementById('tau-slider').value);
            document.getElementById('tau-value').textContent = tau.toFixed(1);

            const tfElement = document.getElementById('first-order-tf');
            katex.render(`H(s) = \\frac{1}{\\tau s + 1} = \\frac{1}{${tau.toFixed(1)}s + 1}`, tfElement, { displayMode: true });
        }

        function updateWn() {
            const wn = parseFloat(document.getElementById('wn-slider').value);
            document.getElementById('wn-value').textContent = wn.toFixed(1);
            updateSecondOrderTF();
        }

        function updateZeta() {
            const zeta = parseFloat(document.getElementById('zeta-slider').value);
            document.getElementById('zeta-value').textContent = zeta.toFixed(2);

            let dampingState = '';
            if (zeta < 1) {
                dampingState = '不足減衰 (Underdamped) - 振動あり';
            } else if (zeta === 1) {
                dampingState = '臨界減衰 (Critically Damped)';
            } else {
                dampingState = '過減衰 (Overdamped) - 振動なし';
            }
            document.getElementById('damping-state').textContent = dampingState;

            updateSecondOrderTF();
        }

        function updateSecondOrderTF() {
            const wn = parseFloat(document.getElementById('wn-slider').value);
            const zeta = parseFloat(document.getElementById('zeta-slider').value);

            const tfElement = document.getElementById('second-order-tf');
            katex.render(`H(s) = \\frac{\\omega_n^2}{s^2 + 2\\zeta\\omega_n s + \\omega_n^2} = \\frac{${wn.toFixed(1)}^2}{s^2 + ${(2*zeta*wn).toFixed(2)}s + ${(wn*wn).toFixed(2)}}`, tfElement, { displayMode: true });
        }

        function plotImpulseResponse() {
            const systemType = document.getElementById('system-type').value;
            const tMax = 10;
            const dt = 0.01;
            const t = [];
            const impulse = [];

            for (let time = 0; time <= tMax; time += dt) {
                t.push(time);

                if (systemType === 'first-order') {
                    const tau = parseFloat(document.getElementById('tau-slider').value);
                    impulse.push((1/tau) * Math.exp(-time/tau));
                } else {
                    const wn = parseFloat(document.getElementById('wn-slider').value);
                    const zeta = parseFloat(document.getElementById('zeta-slider').value);

                    if (zeta < 1) {
                        const wd = wn * Math.sqrt(1 - zeta * zeta);
                        impulse.push((wn / Math.sqrt(1 - zeta * zeta)) * Math.exp(-zeta * wn * time) * Math.sin(wd * time));
                    } else if (zeta === 1) {
                        impulse.push(wn * wn * time * Math.exp(-wn * time));
                    } else {
                        const r1 = -zeta * wn + wn * Math.sqrt(zeta * zeta - 1);
                        const r2 = -zeta * wn - wn * Math.sqrt(zeta * zeta - 1);
                        impulse.push((r1 * Math.exp(r2 * time) - r2 * Math.exp(r1 * time)) / (r1 - r2));
                    }
                }
            }

            const ctx = document.getElementById('impulseChart').getContext('2d');

            if (impulseChart) {
                impulseChart.destroy();
            }

            impulseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'インパルス応答 h(t)',
                        data: impulse,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'インパルス応答 (Impulse Response)',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '時間 t [s]'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 11
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'h(t)'
                            }
                        }
                    }
                }
            });
        }

        function plotStepResponse() {
            const systemType = document.getElementById('system-type').value;
            const tMax = 10;
            const dt = 0.01;
            const t = [];
            const impulse = [];
            const step = [];

            for (let time = 0; time <= tMax; time += dt) {
                t.push(time);

                if (systemType === 'first-order') {
                    const tau = parseFloat(document.getElementById('tau-slider').value);
                    impulse.push((1/tau) * Math.exp(-time/tau));
                    step.push(1 - Math.exp(-time/tau));
                } else {
                    const wn = parseFloat(document.getElementById('wn-slider').value);
                    const zeta = parseFloat(document.getElementById('zeta-slider').value);

                    if (zeta < 1) {
                        const wd = wn * Math.sqrt(1 - zeta * zeta);
                        impulse.push((wn / Math.sqrt(1 - zeta * zeta)) * Math.exp(-zeta * wn * time) * Math.sin(wd * time));
                        step.push(1 - (Math.exp(-zeta * wn * time) / Math.sqrt(1 - zeta * zeta)) * Math.sin(wd * time + Math.acos(zeta)));
                    } else if (zeta === 1) {
                        impulse.push(wn * wn * time * Math.exp(-wn * time));
                        step.push(1 - (1 + wn * time) * Math.exp(-wn * time));
                    } else {
                        const r1 = -zeta * wn + wn * Math.sqrt(zeta * zeta - 1);
                        const r2 = -zeta * wn - wn * Math.sqrt(zeta * zeta - 1);
                        impulse.push((r1 * Math.exp(r2 * time) - r2 * Math.exp(r1 * time)) / (r1 - r2));
                        step.push(1 + (r2 * Math.exp(r1 * time) - r1 * Math.exp(r2 * time)) / (r1 - r2));
                    }
                }
            }

            const ctx = document.getElementById('impulseChart').getContext('2d');

            if (impulseChart) {
                impulseChart.destroy();
            }

            impulseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'インパルス応答 h(t)',
                        data: impulse,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: 'ステップ応答 s(t)',
                        data: step,
                        borderColor: 'rgba(245, 87, 108, 1)',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'インパルス応答とステップ応答 (Impulse & Step Response)',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '時間 t [s]'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 11
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '応答'
                            }
                        }
                    }
                }
            });
        }

        // Tab 2: Convolution Functions
        function startConvolution() {
            isAnimating = true;
            animateConvolution();
        }

        function pauseConvolution() {
            isAnimating = false;
            if (convolutionAnimationId) {
                clearTimeout(convolutionAnimationId);
            }
        }

        function resetConvolution() {
            pauseConvolution();
            currentTime = 0;
            document.getElementById('time-slider').value = 0;
            document.getElementById('time-value').textContent = '0.0';
            updateConvolutionPlot();
        }

        function animateConvolution() {
            if (!isAnimating) return;

            currentTime += 0.1;
            if (currentTime > 10) {
                currentTime = 0;
            }

            document.getElementById('time-slider').value = currentTime;
            document.getElementById('time-value').textContent = currentTime.toFixed(1);
            updateConvolutionPlot();

            convolutionAnimationId = setTimeout(animateConvolution, 100);
        }

        function updateConvolutionTime() {
            currentTime = parseFloat(document.getElementById('time-slider').value);
            document.getElementById('time-value').textContent = currentTime.toFixed(1);
            updateConvolutionPlot();
        }

        function updateConvolutionPlot() {
            const inputType = document.getElementById('input-signal').value;
            const impulseType = document.getElementById('impulse-response').value;

            const tMax = 10;
            const dt = 0.01;
            const tau = [];
            const x = [];
            const h = [];
            const y = [];

            for (let time = 0; time <= tMax; time += dt) {
                tau.push(time);

                // Input signal x(tau)
                switch(inputType) {
                    case 'step':
                        x.push(1);
                        break;
                    case 'pulse':
                        x.push(time >= 0 && time <= 2 ? 1 : 0);
                        break;
                    case 'ramp':
                        x.push(time);
                        break;
                    case 'exp':
                        x.push(Math.exp(-time));
                        break;
                }

                // Impulse response h(t-tau)
                const shiftedTime = currentTime - time;
                let hValue = 0;
                if (shiftedTime >= 0) {
                    switch(impulseType) {
                        case 'exp-decay':
                            hValue = Math.exp(-shiftedTime);
                            break;
                        case 'exp-decay-fast':
                            hValue = 2 * Math.exp(-2*shiftedTime);
                            break;
                        case 'exp-decay-slow':
                            hValue = 0.5 * Math.exp(-0.5*shiftedTime);
                            break;
                    }
                }
                h.push(hValue);
            }

            // Calculate convolution output
            for (let time = 0; time <= tMax; time += dt) {
                let sum = 0;
                for (let i = 0; i < tau.length; i++) {
                    if (tau[i] <= time) {
                        const xValue = x[i];
                        const tauIdx = Math.round(time / dt) - i;
                        if (tauIdx >= 0 && tauIdx < tau.length) {
                            let hValue = 0;
                            const hTime = tau[tauIdx];
                            switch(impulseType) {
                                case 'exp-decay':
                                    hValue = Math.exp(-hTime);
                                    break;
                                case 'exp-decay-fast':
                                    hValue = 2 * Math.exp(-2*hTime);
                                    break;
                                case 'exp-decay-slow':
                                    hValue = 0.5 * Math.exp(-0.5*hTime);
                                    break;
                            }
                            sum += xValue * hValue * dt;
                        }
                    }
                }
                y.push(sum);
            }

            // Plot signals
            const ctx1 = document.getElementById('signalsChart').getContext('2d');
            if (signalsChart) {
                signalsChart.destroy();
            }

            const xPlot = x.slice(0, Math.round(currentTime / dt) + 1);
            const hPlot = h.slice(0, Math.round(currentTime / dt) + 1);
            const tauPlot = tau.slice(0, Math.round(currentTime / dt) + 1);

            signalsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: tauPlot,
                    datasets: [{
                        label: 'x(τ)',
                        data: xPlot,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: `h(${currentTime.toFixed(1)}-τ)`,
                        data: hPlot,
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '入力とインパルス応答 (Input & Impulse Response)',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'τ' },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            title: { display: true, text: '振幅' }
                        }
                    }
                }
            });

            // Plot convolution result
            const ctx2 = document.getElementById('convolutionChart').getContext('2d');
            if (convolutionChart) {
                convolutionChart.destroy();
            }

            const yPlot = y.slice(0, Math.round(currentTime / dt) + 1);
            const tPlot = tau.slice(0, Math.round(currentTime / dt) + 1);

            convolutionChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: tPlot,
                    datasets: [{
                        label: 'y(t) = x(t) * h(t)',
                        data: yPlot,
                        borderColor: 'rgba(76, 175, 80, 1)',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '畳み込み結果 (Convolution Result)',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 't' },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            title: { display: true, text: 'y(t)' }
                        }
                    }
                }
            });
        }

        // Tab 3: LTI Properties Functions
        function verifyLinearity() {
            const a1 = parseFloat(document.getElementById('a1').value);
            const a2 = parseFloat(document.getElementById('a2').value);
            const tau = parseFloat(document.getElementById('linearity-tau').value);
            const signal1Type = document.getElementById('signal1-type').value;
            const signal2Type = document.getElementById('signal2-type').value;

            const tMax = 10;
            const dt = 0.01;
            const t = [];
            const y1 = [];
            const y2 = [];
            const ySum = [];
            const yCombined = [];

            for (let time = 0; time <= tMax; time += dt) {
                t.push(time);

                // Response to signal 1
                let y1Val = 0;
                if (signal1Type === 'step') {
                    y1Val = a1 * (1 - Math.exp(-time/tau));
                } else {
                    y1Val = a1 * tau * (1 - Math.exp(-time/tau));
                }
                y1.push(y1Val);

                // Response to signal 2
                let y2Val = 0;
                if (signal2Type === 'step') {
                    y2Val = a2 * (1 - Math.exp(-time/tau));
                } else {
                    y2Val = a2 * tau * (1 - Math.exp(-time/tau));
                }
                y2.push(y2Val);

                // Sum of individual responses
                ySum.push(y1Val + y2Val);

                // Response to combined input
                let x1 = signal1Type === 'step' ? a1 : a1 * time;
                let x2 = signal2Type === 'step' ? a2 : a2 * time;
                let xCombined = x1 + x2;

                if (signal1Type === 'step' && signal2Type === 'step') {
                    yCombined.push((a1 + a2) * (1 - Math.exp(-time/tau)));
                } else if (signal1Type === 'exp' && signal2Type === 'exp') {
                    yCombined.push((a1 + a2) * tau * (1 - Math.exp(-time/tau)));
                } else {
                    yCombined.push(y1Val + y2Val);
                }
            }

            // Calculate error
            let maxError = 0;
            for (let i = 0; i < ySum.length; i++) {
                const error = Math.abs(ySum[i] - yCombined[i]);
                if (error > maxError) maxError = error;
            }

            // Display result
            const resultDiv = document.getElementById('linearity-result');
            const contentDiv = document.getElementById('linearity-result-content');
            resultDiv.style.display = 'block';

            if (maxError < 0.001) {
                contentDiv.innerHTML = `
                    <div class="success-message">
                        <strong>✓ 線形性が確認されました！</strong><br>
                        T{a₁x₁ + a₂x₂} = a₁T{x₁} + a₂T{x₂}<br>
                        最大誤差: ${maxError.toExponential(2)}
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="error-message">
                        <strong>✗ 誤差が検出されました</strong><br>
                        最大誤差: ${maxError.toFixed(6)}
                    </div>
                `;
            }

            // Plot
            const ctx = document.getElementById('linearityChart').getContext('2d');
            if (linearityChart) {
                linearityChart.destroy();
            }

            linearityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: `a₁y₁(t) (a₁=${a1})`,
                        data: y1,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: `a₂y₂(t) (a₂=${a2})`,
                        data: y2,
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: 'a₁y₁(t) + a₂y₂(t)',
                        data: ySum,
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: 'T{a₁x₁ + a₂x₂}',
                        data: yCombined,
                        borderColor: 'rgba(255, 152, 0, 1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '線形性の検証 (Linearity Verification)',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: '時間 t [s]' },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 11
                            }
                        },
                        y: {
                            title: { display: true, text: '出力' }
                        }
                    }
                }
            });
        }

        function verifyTimeInvariance() {
            const signalType = document.getElementById('ti-signal-type').value;
            const delay = parseFloat(document.getElementById('time-delay').value);
            const tau = parseFloat(document.getElementById('ti-tau').value);

            const tMax = 15;
            const dt = 0.01;
            const t = [];
            const y1 = [];
            const y2 = [];

            for (let time = 0; time <= tMax; time += dt) {
                t.push(time);

                // Response to original signal
                if (signalType === 'pulse') {
                    if (time >= 0 && time <= 2) {
                        y1.push(1 - Math.exp(-time/tau));
                    } else if (time > 2) {
                        const rise = 1 - Math.exp(-2/tau);
                        const decay = rise * Math.exp(-(time-2)/tau);
                        y1.push(decay);
                    } else {
                        y1.push(0);
                    }
                } else {
                    y1.push(tau * (1 - Math.exp(-time/tau)));
                }

                // Response to delayed signal
                const delayedTime = time - delay;
                if (signalType === 'pulse') {
                    if (delayedTime >= 0 && delayedTime <= 2) {
                        y2.push(1 - Math.exp(-delayedTime/tau));
                    } else if (delayedTime > 2) {
                        const rise = 1 - Math.exp(-2/tau);
                        const decay = rise * Math.exp(-(delayedTime-2)/tau);
                        y2.push(decay);
                    } else {
                        y2.push(0);
                    }
                } else {
                    if (delayedTime >= 0) {
                        y2.push(tau * (1 - Math.exp(-delayedTime/tau)));
                    } else {
                        y2.push(0);
                    }
                }
            }

            // Display result
            const resultDiv = document.getElementById('ti-result');
            const contentDiv = document.getElementById('ti-result-content');
            resultDiv.style.display = 'block';

            contentDiv.innerHTML = `
                <div class="success-message">
                    <strong>✓ 時不変性が確認されました！</strong><br>
                    入力をT秒遅延 → 出力もT秒遅延<br>
                    時間遅延: ${delay}秒
                </div>
                <p style="margin-top: 15px;">
                    グラフを見ると、出力y₂(t)は出力y₁(t)を${delay}秒遅延させたものと一致しています。
                    これがLTIシステムの時不変性です。
                </p>
            `;

            // Plot
            const ctx = document.getElementById('timeInvarianceChart').getContext('2d');
            if (timeInvarianceChart) {
                timeInvarianceChart.destroy();
            }

            timeInvarianceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'y₁(t) = T{x(t)}',
                        data: y1,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: `y₂(t) = T{x(t-${delay})}`,
                        data: y2,
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '時不変性の検証 (Time Invariance Verification)',
                            font: { size: 18 }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: '時間 t [s]' },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                maxTicksLimit: 11
                            }
                        },
                        y: {
                            title: { display: true, text: '出力' }
                        }
                    }
                }
            });
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            updateSystemParameters();
            plotImpulseResponse();
            updateConvolutionPlot();

            // Render formulas
            katex.render('y(t) = \\int_{-\\infty}^{\\infty} h(\\tau)x(t-\\tau)d\\tau',
                document.getElementById('convolution-formula'), { displayMode: true });

            katex.render('T\\{a_1x_1(t) + a_2x_2(t)\\} = a_1T\\{x_1(t)\\} + a_2T\\{x_2(t)\\}',
                document.getElementById('linearity-formula'), { displayMode: true });

            katex.render('x(t-T) \\rightarrow y(t-T) \\quad \\text{(入力の遅延} \\rightarrow \\text{出力の遅延)}',
                document.getElementById('time-invariance-formula'), { displayMode: true });

            // Render all math
            setTimeout(() => {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ]
                });
            }, 500);
        });
    </script>
</body>
</html>
