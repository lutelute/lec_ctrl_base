# 第8章 FB制御とFF制御 - 理解者向け技術ノート

## 1. 制御系の伝達関数解析

### 1.1 一般化された制御系の定式化

一般的な制御系は、以下の信号を含みます：

- $$r(t)$$：目標値（Reference signal）
- $$y(t)$$：制御出力（Controlled output）
- $$u(t)$$：操作量（Control input）
- $$d(t)$$：外乱（Disturbance）
- $$n(t)$$：測定ノイズ（Measurement noise）

ラプラス変換表記では：

- $$G(s)$$：プラント伝達関数
- $$C(s)$$：フィードバック制御器
- $$F(s)$$：フィードフォワード補償器

### 1.2 フィードバック制御系の詳細解析

標準的なフィードバック制御系のブロック線図から、閉ループ伝達関数を導出します。

**基本方程式**：

$$
\begin{align}
E(s) &= R(s) - Y(s) \\
U(s) &= C(s) \cdot E(s) \\
Y(s) &= G(s) \cdot U(s) + G_d(s) \cdot D(s)
\end{align}
$$

ここで、$$G_d(s)$$ は外乱から出力への伝達関数です（多くの場合 $$G_d(s) = G(s)$$）。

**閉ループ伝達関数の導出**：

$$
\begin{align}
Y(s) &= G(s) \cdot C(s) \cdot (R(s) - Y(s)) + G_d(s) \cdot D(s) \\
Y(s) \cdot (1 + G(s) \cdot C(s)) &= G(s) \cdot C(s) \cdot R(s) + G_d(s) \cdot D(s) \\
Y(s) &= \frac{G(s) \cdot C(s)}{1 + G(s) \cdot C(s)} \cdot R(s) + \frac{G_d(s)}{1 + G(s) \cdot C(s)} \cdot D(s)
\end{align}
$$

### 1.3 感度関数と相補感度関数

**感度関数（Sensitivity Function）** $$S(s)$$：

$$S(s) = \frac{1}{1 + G(s) \cdot C(s)}$$

**相補感度関数（Complementary Sensitivity Function）** $$T(s)$$：

$$T(s) = \frac{G(s) \cdot C(s)}{1 + G(s) \cdot C(s)} = 1 - S(s)$$

**重要な関係式**：

$$S(s) + T(s) = 1$$

この関係式は、制御設計における根本的なトレードオフを表しています。

### 1.4 各伝達関数の物理的意味

閉ループ系の出力は、重ね合わせの原理により：

$$Y(s) = T(s) \cdot R(s) + S(s) \cdot G_d(s) \cdot D(s)$$

**相補感度関数 $$T(s)$$ の役割**：
- 目標値追従性能を決定
- 理想的には $$T(s) \approx 1$$ （全周波数帯域）
- 高周波数では $$|T(s)| \ll 1$$ が必要（測定ノイズ増幅の抑制）

**感度関数 $$S(s)$$ の役割**：
- 外乱抑制性能を決定
- パラメータ変動に対するロバスト性を表現
- 低周波数では $$|S(s)| \ll 1$$ が望ましい（外乱抑制）

## 2. 外乱抑制理論

### 2.1 外乱抑制の基本原理

外乱が出力に与える影響は：

$$\frac{Y(s)}{D(s)} = \frac{G_d(s)}{1 + G(s) \cdot C(s)} = S(s) \cdot G_d(s)$$

**外乱抑制の条件**：

$$\left| \frac{Y(s)}{D(s)} \right| = |S(s) \cdot G_d(s)| \ll 1$$

これを実現するには：

1. $$|G(s) \cdot C(s)| \gg 1$$ とする（ループゲインを大きくする）
2. 外乱が入力される周波数帯域で $$|S(s)|$$ を小さくする

### 2.2 定常外乱の完全除去

**定理（内部モデル原理, Internal Model Principle）**：

定常外乱 $$d(t) = d_0$$ （ステップ外乱）を完全に除去するには、制御器 $$C(s)$$ が積分器 $$\frac{1}{s}$$ を含む必要があります。

**証明**：

ステップ外乱 $$D(s) = \frac{d_0}{s}$$ に対する定常偏差は：

$$e_{ss} = \lim_{s \to 0} s \cdot E(s) = \lim_{s \to 0} s \cdot S(s) \cdot R(s) + \lim_{s \to 0} s \cdot S(s) \cdot \frac{d_0}{s}$$

目標値が一定（$$R(s) = \frac{r_0}{s}$$）の場合、第2項のみが問題となり：

$$e_{ss,d} = \lim_{s \to 0} S(s) \cdot d_0 = \lim_{s \to 0} \frac{d_0}{1 + G(s) \cdot C(s)}$$

$$C(s)$$ が積分器 $$\frac{K_I}{s}$$ を含む場合：

$$\lim_{s \to 0} G(s) \cdot C(s) = \lim_{s \to 0} G(s) \cdot \frac{K_I}{s} = \infty$$

したがって：

$$e_{ss,d} = \frac{d_0}{\infty} = 0$$

**一般化**：

周波数 $$\omega_0$$ の正弦波外乱 $$d(t) = d_0 \sin(\omega_0 t)$$ を除去するには、制御器が $$\frac{s}{s^2 + \omega_0^2}$$ を含む必要があります。

### 2.3 外乱オブザーバ（Disturbance Observer）

外乱を推定して補償する手法として、**外乱オブザーバ（DOB）** があります。

**基本構造**：

プラント $$G(s)$$ の逆モデル $$G_n^{-1}(s)$$ を用いて、外乱を推定します：

$$\hat{D}(s) = Q(s) \cdot (G_n^{-1}(s) \cdot Y(s) - U(s))$$

ここで：
- $$G_n(s)$$：プラントの公称モデル
- $$Q(s)$$：ローパスフィルタ（$$Q(s) \approx 1$$ at low freq）

外乱推定値を操作量から差し引くことで、外乱を補償します：

$$U_{total}(s) = U(s) - \hat{D}(s)$$

**特徴**：
- プラントモデルの逆系が必要
- 高周波数では $$Q(s) \approx 0$$ として実現可能性を確保
- ロバスト性が高い

## 3. モデル不確かさとロバスト性

### 3.1 モデル化誤差の分類

実際のプラント $$G(s)$$ と公称モデル $$G_n(s)$$ には必ず誤差があります：

**加法的不確かさ（Additive Uncertainty）**：

$$G(s) = G_n(s) + \Delta_a(s)$$

**乗法的不確かさ（Multiplicative Uncertainty）**：

$$G(s) = G_n(s) \cdot (1 + \Delta_m(s))$$

ここで、$$\Delta_a(s)$$、$$\Delta_m(s)$$ は不確かさを表します。

### 3.2 ロバスト安定性

**小ゲイン定理（Small Gain Theorem）**：

乗法的不確かさ $$|\Delta_m(j\omega)| \leq l_m(\omega)$$ の下で、閉ループ系がロバスト安定であるための十分条件は：

$$|T(j\omega)| \cdot l_m(\omega) < 1, \quad \forall \omega$$

すなわち：

$$|T(j\omega)| < \frac{1}{l_m(\omega)}$$

**意味**：
- 相補感度関数 $$T(s)$$ を適切に整形する必要がある
- 不確かさが大きい高周波数帯域では $$|T(j\omega)|$$ を小さくする
- これは測定ノイズ抑制の要求とも一致する

### 3.3 ロバスト性能

不確かさが存在する状況でも性能を保証する条件：

**感度関数に対する制約**：

$$|S(j\omega)| < \frac{1}{1 + l_s(\omega)}, \quad \forall \omega$$

ここで、$$l_s(\omega)$$ は性能仕様を表す重み関数です。

**相補感度関数に対する制約**：

$$|T(j\omega)| < \frac{1}{l_m(\omega)}, \quad \forall \omega$$

### 3.4 $$H_\infty$$ 制御によるロバスト設計

これらの制約を同時に満たす制御器を設計する方法として、$$H_\infty$$ 制御があります。

**混合感度問題（Mixed Sensitivity Problem）**：

重み関数 $$W_S(s)$$、$$W_T(s)$$ を用いて、以下を最小化します：

$$\left\| \begin{bmatrix} W_S(s) \cdot S(s) \\ W_T(s) \cdot T(s) \end{bmatrix} \right\|_\infty < \gamma$$

ここで、$$\|\cdot\|_\infty$$ は $$H_\infty$$ ノルムです：

$$\|F(s)\|_\infty = \sup_{\omega} |F(j\omega)|$$

## 4. 2自由度制御系の設計手法

### 4.1 2自由度制御系の一般形

2自由度制御系は、目標値応答と外乱抑制を独立に設計できる構造です：

**ブロック線図**：

```
R(s) ----[F(s)]---->(+)----> U(s) ----[G(s)]----> Y(s)
  |                  ↑                              |
  |                  |                              |
  └---->(-)---> E(s)--[C(s)]                        |
        (+)                                         |
         ↑                                          |
         └──────────────────────────────────────────┘
```

**閉ループ伝達関数**：

$$Y(s) = \frac{G(s) \cdot (F(s) + C(s))}{1 + G(s) \cdot C(s)} \cdot R(s) + \frac{G(s)}{1 + G(s) \cdot C(s)} \cdot D(s)$$

$$Y(s) = T_r(s) \cdot R(s) + S(s) \cdot G(s) \cdot D(s)$$

ここで：

$$T_r(s) = \frac{G(s) \cdot (F(s) + C(s))}{1 + G(s) \cdot C(s)}$$

### 4.2 2自由度制御系の設計手順

**Step 1: フィードバック制御器 $$C(s)$$ の設計**

目的：
- 閉ループ系の安定化
- 外乱抑制性能の確保
- ロバスト性の確保

設計方法：
- ループ整形法（Loop Shaping）
- $$H_\infty$$ 制御
- PID制御（実用的な場合）

**感度関数の整形目標**：
- 低周波数：$$|S(j\omega)| \ll 1$$ （外乱抑制）
- 中周波数：$$|S(j\omega)| \approx 1$$、$$|T(j\omega)| \approx 1$$
- 高周波数：$$|T(j\omega)| \ll 1$$ （ノイズ抑制、ロバスト性）

**Step 2: フィードフォワード補償器 $$F(s)$$ の設計**

目的：
- 目標値追従性能の改善
- オーバーシュートの抑制
- 応答速度の向上

**理想的なFF補償器**：

目標値応答を理想的にする（$$T_r(s) = 1$$）には：

$$F(s) = \frac{1}{G(s)} \cdot \frac{1 + G(s) \cdot C(s)}{G(s) \cdot C(s)} - \frac{C(s)}{G(s) \cdot C(s)} = \frac{1}{G(s)}$$

**実用的なFF補償器**：

プラントの逆系 $$G^{-1}(s)$$ が非因果的または不安定な場合、以下のように近似します：

$$F(s) = \frac{1}{G_n(s)} \cdot Q_{ff}(s)$$

ここで：
- $$G_n(s)$$：プラントの安定な公称モデル
- $$Q_{ff}(s)$$：実現可能性を保証するローパスフィルタ

**ローパスフィルタの設計**：

$$Q_{ff}(s) = \frac{1}{(\tau_{ff} s + 1)^n}$$

ここで、$$n$$ は $$F(s)$$ が因果的（プロパー）となるように選びます。

### 4.3 目標値フィルタによる実装

別の実装方法として、目標値フィルタ $$P(s)$$ を用いる方法があります：

```
R(s) --[P(s)]--> R'(s) -->(-)---> E(s) --[C(s)]--> U(s) --[G(s)]--> Y(s)
                          (+)                                         |
                           ↑                                          |
                           └──────────────────────────────────────────┘
```

この場合：

$$Y(s) = \frac{G(s) \cdot C(s) \cdot P(s)}{1 + G(s) \cdot C(s)} \cdot R(s) + S(s) \cdot G(s) \cdot D(s)$$

**目標値フィルタの設計**：

理想的な目標値応答 $$M(s)$$ を実現するには：

$$P(s) = \frac{M(s) \cdot (1 + G(s) \cdot C(s))}{G(s) \cdot C(s)}$$

一般的には、2次系の目標値応答を選択します：

$$M(s) = \frac{\omega_n^2}{s^2 + 2 \zeta \omega_n s + \omega_n^2}$$

ここで、$$\zeta$$ は減衰係数、$$\omega_n$$ は固有角周波数です。

### 4.4 2自由度制御系の利点

| 利点 | 説明 |
|------|------|
| **独立設計** | 外乱抑制（FB）と目標値追従（FF）を独立に設計可能 |
| **高速応答** | FF補償により、FB制御のみより速い応答が可能 |
| **高精度** | FB制御により、FFの不完全さを補償 |
| **オーバーシュート抑制** | 目標値フィルタで応答を整形可能 |
| **設計の自由度** | 性能とロバスト性のトレードオフを調整しやすい |

## 5. 安定性解析

### 5.1 ナイキスト安定判別法

フィードバック制御系の安定性を判別する標準的な方法です。

**ナイキスト軌跡**：

開ループ伝達関数 $$L(s) = G(s) \cdot C(s)$$ のナイキスト軌跡を描きます：

$$L(j\omega), \quad \omega: 0 \to \infty$$

**ナイキストの安定判別法**：

閉ループ系が安定であるための必要十分条件は：

$$N = P$$

ここで：
- $$N$$：ナイキスト軌跡が点 $$(-1, 0)$$ を反時計回りに囲む回数
- $$P$$：開ループ伝達関数 $$L(s)$$ が右半平面に持つ極の数

**実用的には**、開ループ系が安定（$$P = 0$$）の場合、ナイキスト軌跡が点 $$(-1, 0)$$ を囲まなければ、閉ループ系は安定です。

### 5.2 安定余裕

**ゲイン余裕（Gain Margin, GM）**：

位相が $$-180°$$ になる周波数 $$\omega_{pc}$$ でのゲイン余裕：

$$\text{GM} = \frac{1}{|L(j\omega_{pc})|}, \quad \text{GM}_{dB} = -20 \log_{10} |L(j\omega_{pc})|$$

**位相余裕（Phase Margin, PM）**：

ゲインが $$0 \text{ dB}$$ （$$|L(j\omega)| = 1$$）になる周波数 $$\omega_{gc}$$ での位相余裕：

$$\text{PM} = 180° + \angle L(j\omega_{gc})$$

**推奨値**：
- ゲイン余裕：$$\text{GM} > 6 \text{ dB}$$ （約2倍）
- 位相余裕：$$\text{PM} > 30°$$ （理想的には $$45° \sim 60°$$）

### 5.3 ボード線図による安定性解析

ボード線図（ゲイン線図と位相線図）を用いて、安定余裕を読み取ります：

**ゲイン余裕の読み取り**：
1. 位相が $$-180°$$ になる周波数 $$\omega_{pc}$$ を見つける
2. その周波数でのゲイン $$|L(j\omega_{pc})|_{dB}$$ を読む
3. ゲイン余裕は $$\text{GM}_{dB} = -|L(j\omega_{pc})|_{dB}$$

**位相余裕の読み取り**：
1. ゲインが $$0 \text{ dB}$$ になる周波数 $$\omega_{gc}$$ を見つける
2. その周波数での位相 $$\angle L(j\omega_{gc})$$ を読む
3. 位相余裕は $$\text{PM} = 180° + \angle L(j\omega_{gc})$$

### 5.4 内部安定性

2自由度制御系では、**内部安定性（Internal Stability）** を確認する必要があります。

すべての伝達関数が安定であることが必要：

- $$S(s) = \frac{1}{1 + G(s) \cdot C(s)}$$
- $$T(s) = \frac{G(s) \cdot C(s)}{1 + G(s) \cdot C(s)}$$
- $$C(s) \cdot S(s) = \frac{C(s)}{1 + G(s) \cdot C(s)}$$
- $$G(s) \cdot S(s) = \frac{G(s)}{1 + G(s) \cdot C(s)}$$

**極零相殺の危険性**：

プラント $$G(s)$$ と制御器 $$C(s)$$ の間で不安定な極零相殺があると、見かけ上は安定でも内部的に不安定な信号が存在する可能性があります。

## 6. 実践的な設計例

### 6.1 例題：1次遅れ系の2自由度制御

**プラント**：

$$G(s) = \frac{K}{Ts + 1}$$

ここで、$$K = 2.0$$、$$T = 0.5 \text{ s}$$ とします。

**Step 1: PI制御器の設計**

PI制御器：

$$C(s) = K_P + \frac{K_I}{s} = K_P \cdot \frac{s + K_I/K_P}{s} = K_P \cdot \frac{s + z_c}{s}$$

ここで、$$K_P = 1.5$$、$$K_I = 3.0$$ とすると、$$z_c = 2.0$$ です。

**開ループ伝達関数**：

$$L(s) = G(s) \cdot C(s) = \frac{2.0}{0.5s + 1} \cdot 1.5 \cdot \frac{s + 2.0}{s} = \frac{3.0(s + 2.0)}{s(0.5s + 1)}$$

**閉ループ伝達関数**：

$$T(s) = \frac{L(s)}{1 + L(s)} = \frac{3.0(s + 2.0)}{s(0.5s + 1) + 3.0(s + 2.0)} = \frac{3.0s + 6.0}{0.5s^2 + 4.0s + 6.0}$$

標準形に変換：

$$T(s) = \frac{6(s + 2.0)}{s^2 + 8.0s + 12.0}$$

特性方程式の根：

$$s^2 + 8.0s + 12.0 = 0$$

$$s = \frac{-8.0 \pm \sqrt{64 - 48}}{2} = \frac{-8.0 \pm 4.0}{2} = -2.0, -6.0$$

両方とも左半平面にあるため、閉ループ系は安定です。

**感度関数**：

$$S(s) = \frac{1}{1 + L(s)} = \frac{s(0.5s + 1)}{0.5s^2 + 4.0s + 6.0} = \frac{0.5s^2 + s}{0.5s^2 + 4.0s + 6.0}$$

定常ゲイン：

$$\lim_{s \to 0} S(s) = \frac{0}{6.0} = 0$$

これは、ステップ外乱に対して定常偏差が零になることを意味します（積分器の効果）。

**Step 2: FF補償器の設計**

プラントの逆系：

$$F(s) = G^{-1}(s) = \frac{Ts + 1}{K} = \frac{0.5s + 1}{2.0}$$

これは既にプロパー（因果的）であるため、そのまま使用できます。

ただし、微分項 $$s$$ を含むため、実際にはローパスフィルタを付加します：

$$F(s) = \frac{0.5s + 1}{2.0} \cdot \frac{1}{\tau_{ff} s + 1}$$

$$\tau_{ff} = 0.1 \text{ s}$$ とすると：

$$F(s) = \frac{0.5s + 1}{2.0(0.1s + 1)}$$

**目標値応答**：

$$T_r(s) = \frac{G(s) \cdot (F(s) + C(s))}{1 + G(s) \cdot C(s)}$$

理想的には、$$F(s) = G^{-1}(s)$$ のとき：

$$T_r(s) \approx 1 \quad (\text{低周波数帯域})$$

### 6.2 性能評価

**ステップ応答のシミュレーション**（概念的な結果）：

- **FB制御のみ** （$$F(s) = 0$$）：
  - 立ち上がり時間：約 $$0.5 \text{ s}$$
  - オーバーシュート：約 $$15\%$$
  - 整定時間：約 $$1.5 \text{ s}$$

- **2自由度制御** （$$F(s) \neq 0$$）：
  - 立ち上がり時間：約 $$0.3 \text{ s}$$ （改善）
  - オーバーシュート：約 $$5\%$$ （改善）
  - 整定時間：約 $$0.8 \text{ s}$$ （改善）

**外乱応答**：

両方の制御系で、外乱抑制性能は同じです（$$S(s)$$ が同じため）。

### 6.3 設計パラメータの調整指針

**FB制御器のゲイン調整**：

- $$K_P$$ を大きくする → 応答が速くなるが、オーバーシュートが増加
- $$K_I$$ を大きくする → 定常偏差が速く除去されるが、振動的になる可能性

**FF補償器の調整**：

- $$\tau_{ff}$$ を小さくする → 目標値応答が速くなるが、高周波ノイズに敏感
- $$\tau_{ff}$$ を大きくする → 応答が遅くなるが、ロバスト性が向上

**安定余裕の確認**：

ボード線図を描いて、以下を確認します：
- ゲイン余裕 $$> 6 \text{ dB}$$
- 位相余裕 $$> 45°$$

### 6.4 高次系への拡張

2次遅れ系やより高次のプラントの場合：

**プラント**：

$$G(s) = \frac{K \omega_n^2}{s^2 + 2\zeta \omega_n s + \omega_n^2}$$

**制御器設計**：

- PID制御器の使用
- 極配置法による設計
- $$H_\infty$$ 制御による設計

**FF補償器**：

プラントの逆系が非因果的（分子の次数 $$>$$ 分母の次数）の場合、近似逆系を使用：

$$F(s) = \frac{s^2 + 2\zeta \omega_n s + \omega_n^2}{K \omega_n^2} \cdot \frac{\omega_n^2}{(s + \omega_n)^2}$$

これにより、因果的かつ実現可能な補償器となります。

## 7. 実用上の考慮事項

### 7.1 アンチワインドアップ（Anti-Windup）

積分器を含む制御器では、アクチュエータの飽和時に積分項が大きくなる **ワインドアップ現象** が発生します。

**対策**：

- バックカルキュレーション法（Back-calculation）
- 条件付き積分（Conditional Integration）
- アンチワインドアップゲインの導入

### 7.2 ノイズフィルタ

測定ノイズが大きい場合、フィードバック経路にローパスフィルタを挿入します：

$$Y_{filtered}(s) = \frac{1}{\tau_f s + 1} \cdot Y(s)$$

ただし、位相遅れが発生するため、安定性に影響します。

### 7.3 ディジタル実装

連続時間制御器をディジタル実装する際の考慮事項：

- サンプリング周期 $$T_s$$ の選択（$$T_s \ll$$ 制御系の時定数）
- 離散化手法（双一次変換、零次ホールド近似）
- 計算遅延の影響

### 7.4 モデルベース制御の限界

すべての制御手法は、モデルの精度に依存します：

- **モデル化誤差** が大きい場合、性能が劣化
- **ロバスト制御** により、不確かさに対処
- **適応制御** により、パラメータ変動に追従

---

## まとめ

本章では、FB制御とFF制御の理論的基盤と実践的設計手法を詳細に学びました：

- **伝達関数解析**：
  - 感度関数 $$S(s)$$ と相補感度関数 $$T(s)$$
  - $$S(s) + T(s) = 1$$ の制約（トレードオフ）

- **外乱抑制理論**：
  - 内部モデル原理（ステップ外乱の完全除去には積分器が必要）
  - 外乱オブザーバによる外乱推定と補償

- **ロバスト性**：
  - モデル不確かさの分類（加法的、乗法的）
  - 小ゲイン定理とロバスト安定性条件
  - $$H_\infty$$ 制御による混合感度問題

- **2自由度制御系**：
  - FB制御器で安定性と外乱抑制を設計
  - FF補償器で目標値追従性能を改善
  - 独立設計が可能な構造

- **安定性解析**：
  - ナイキスト安定判別法
  - 安定余裕（ゲイン余裕、位相余裕）
  - 内部安定性の重要性

- **実践的設計**：
  - 1次遅れ系に対するPI制御器とFF補償器の設計例
  - パラメータ調整の指針
  - 実用上の考慮事項（アンチワインドアップ、ノイズフィルタ）

これらの理論と手法を理解することで、実際の制御系設計において、性能、安定性、ロバスト性のバランスを取った最適な制御器を構築することが可能になります。

**推奨文献**：
- K. J. Åström and R. M. Murray, "Feedback Systems: An Introduction for Scientists and Engineers"
- J. C. Doyle, B. A. Francis, and A. R. Tannenbaum, "Feedback Control Theory"
- S. Skogestad and I. Postlethwaite, "Multivariable Feedback Control: Analysis and Design"
