<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第4章 伝達関数 - インタラクティブ学習ツール</title>

    <!-- KaTeX CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        .tool-section {
            margin-bottom: 30px;
        }

        .tool-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-field input,
        .input-field select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .output-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
            min-height: 60px;
        }

        .output-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .math-output {
            font-size: 1.2em;
            color: #333;
            margin: 10px 0;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 15px;
            border-radius: 8px;
            color: #c33;
            margin: 10px 0;
        }

        .success-message {
            background: #efe;
            border-left: 4px solid #4c4;
            padding: 15px;
            border-radius: 8px;
            color: #363;
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #667eea;
        }

        .step-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .step-container .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                min-width: 100%;
            }

            header h1 {
                font-size: 1.5em;
            }

            .chart-container {
                height: 350px;
            }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>第4章 伝達関数</h1>
            <p>インタラクティブ学習ツール - Interactive Learning Tool</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('transfer')">伝達関数と極零点</button>
            <button class="tab-button" onclick="showTab('response')">時間応答</button>
            <button class="tab-button" onclick="showTab('blockdiagram')">ブロック線図計算機</button>
        </div>

        <!-- Tab 1: Transfer Function and Pole-Zero -->
        <div id="transfer-tab" class="tab-content active">
            <div class="tool-section">
                <h2>伝達関数と極零点プロット (Transfer Function & Pole-Zero Plot)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> 伝達関数のタイプを選択すると、極零点配置と伝達関数の式が表示されます。
                    極と零点がシステムの特性にどう影響するかを確認できます。
                </div>

                <div class="input-field">
                    <label>伝達関数を選択 (Select Transfer Function):</label>
                    <select id="tf-select" onchange="updateTransferFunction()">
                        <option value="first-order">1次系: G(s) = K/(τs+1)</option>
                        <option value="second-order">2次系: G(s) = ω²/(s²+2ζωs+ω²)</option>
                        <option value="integrator">積分系: G(s) = K/s</option>
                        <option value="with-zero">零点付き2次系</option>
                        <option value="double-pole">2重極系</option>
                        <option value="complex-poles">複素共役極系</option>
                    </select>
                </div>

                <div id="tf-parameters" class="input-group">
                    <!-- Dynamic parameters will be inserted here -->
                </div>

                <div>
                    <button class="btn" onclick="plotPoleZero()">極零点をプロット</button>
                    <button class="btn btn-secondary" onclick="clearPoleZero()">クリア</button>
                </div>

                <div class="output-box">
                    <h3>伝達関数 (Transfer Function)</h3>
                    <div id="tf-output"></div>
                </div>

                <div class="chart-container">
                    <canvas id="poleZeroPlot"></canvas>
                </div>

                <div class="tool-section">
                    <h2>標準的な伝達関数 (Standard Transfer Functions)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>システム</th>
                                <th>伝達関数 G(s)</th>
                                <th>特徴</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>比例要素</td>
                                <td><span class="math-inline">K</span></td>
                                <td>ゲインのみ、極零点なし</td>
                            </tr>
                            <tr>
                                <td>1次遅れ</td>
                                <td><span class="math-inline">\frac{K}{\tau s + 1}</span></td>
                                <td>実極 s = -1/τ</td>
                            </tr>
                            <tr>
                                <td>積分要素</td>
                                <td><span class="math-inline">\frac{K}{s}</span></td>
                                <td>原点に極</td>
                            </tr>
                            <tr>
                                <td>微分要素</td>
                                <td><span class="math-inline">Ks</span></td>
                                <td>原点に零点</td>
                            </tr>
                            <tr>
                                <td>2次系</td>
                                <td><span class="math-inline">\frac{\omega_n^2}{s^2 + 2\zeta\omega_n s + \omega_n^2}</span></td>
                                <td>複素共役極 (ζ<1)</td>
                            </tr>
                            <tr>
                                <td>1次進み</td>
                                <td><span class="math-inline">K(\tau s + 1)</span></td>
                                <td>実零点 s = -1/τ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Time Response -->
        <div id="response-tab" class="tab-content">
            <div class="tool-section">
                <h2>時間応答シミュレータ (Time Response Simulator)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> システムを選択し、ステップ応答またはインパルス応答を表示します。
                    パラメータを変更して、システムの動特性を確認できます。
                </div>

                <div class="input-field">
                    <label>応答タイプ (Response Type):</label>
                    <select id="response-type">
                        <option value="step">ステップ応答</option>
                        <option value="impulse">インパルス応答</option>
                    </select>
                </div>

                <div class="input-field">
                    <label>システムタイプ (System Type):</label>
                    <select id="system-select" onchange="updateSystemParameters()">
                        <option value="first-order">1次系</option>
                        <option value="second-order-underdamped">2次系（不足制動）</option>
                        <option value="second-order-critical">2次系（臨界制動）</option>
                        <option value="second-order-overdamped">2次系（過制動）</option>
                    </select>
                </div>

                <div id="system-parameters" class="input-group">
                    <!-- Dynamic parameters will be inserted here -->
                </div>

                <div>
                    <button class="btn" onclick="calculateResponse()">応答を計算</button>
                    <button class="btn btn-secondary" onclick="showSpecifications()">仕様を表示</button>
                </div>

                <div class="chart-container">
                    <canvas id="responseChart"></canvas>
                </div>

                <div class="output-box" id="specs-output" style="display: none;">
                    <h3>時間応答の仕様 (Time Response Specifications)</h3>
                    <div id="specs-content"></div>
                </div>

                <div class="tool-section">
                    <h2>時間応答の特性値 (Time Response Characteristics)</h2>

                    <div class="step">
                        <strong>ステップ応答の主な特性値:</strong>
                        <ul style="margin-top: 10px; margin-left: 30px;">
                            <li><strong>立ち上がり時間 (Rise Time):</strong> 定常値の10%から90%に達するまでの時間</li>
                            <li><strong>整定時間 (Settling Time):</strong> 定常値の±2%以内に収まるまでの時間</li>
                            <li><strong>オーバーシュート (Overshoot):</strong> 定常値を超える最大偏差の割合</li>
                            <li><strong>ピーク時間 (Peak Time):</strong> 最大オーバーシュートに達するまでの時間</li>
                        </ul>
                    </div>

                    <div class="step">
                        <strong>2次系の標準形:</strong>
                        <div class="math-output">
                            $$G(s) = \frac{\omega_n^2}{s^2 + 2\zeta\omega_n s + \omega_n^2}$$
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            ω<sub>n</sub>: 固有角周波数、ζ: 減衰係数
                        </p>
                    </div>

                    <div class="step">
                        <strong>減衰係数による分類:</strong>
                        <ul style="margin-top: 10px; margin-left: 30px;">
                            <li><strong>不足制動 (Underdamped):</strong> 0 < ζ < 1 → 振動応答</li>
                            <li><strong>臨界制動 (Critically Damped):</strong> ζ = 1 → 最速非振動応答</li>
                            <li><strong>過制動 (Overdamped):</strong> ζ > 1 → ゆっくりとした非振動応答</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Block Diagram Calculator -->
        <div id="blockdiagram-tab" class="tab-content">
            <div class="tool-section">
                <h2>ブロック線図計算機 (Block Diagram Calculator)</h2>

                <div class="info-box">
                    <strong>使い方:</strong> 結合タイプを選択し、各ブロックの伝達関数を入力します。
                    合成伝達関数が自動的に計算されます。
                </div>

                <div class="input-field">
                    <label>結合タイプ (Connection Type):</label>
                    <select id="connection-type" onchange="updateConnectionInputs()">
                        <option value="series">直列結合 (Series)</option>
                        <option value="parallel">並列結合 (Parallel)</option>
                        <option value="feedback">フィードバック結合 (Feedback)</option>
                    </select>
                </div>

                <div id="block-inputs" class="input-group">
                    <!-- Dynamic inputs will be inserted here -->
                </div>

                <div>
                    <button class="btn" onclick="calculateBlockDiagram()">合成伝達関数を計算</button>
                    <button class="btn btn-secondary" onclick="clearBlockDiagram()">クリア</button>
                </div>

                <div class="output-box">
                    <h3>合成伝達関数 (Combined Transfer Function)</h3>
                    <div id="block-output"></div>
                </div>

                <div class="tool-section">
                    <h2>ブロック線図の結合則 (Block Diagram Combination Rules)</h2>

                    <div class="step">
                        <span class="step-number">1</span>
                        <strong>直列結合 (Series Connection):</strong>
                        <div class="math-output">
                            $$G(s) = G_1(s) \cdot G_2(s)$$
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            2つの伝達関数を直列に接続すると、全体の伝達関数は各伝達関数の積になります。
                        </p>
                    </div>

                    <div class="step">
                        <span class="step-number">2</span>
                        <strong>並列結合 (Parallel Connection):</strong>
                        <div class="math-output">
                            $$G(s) = G_1(s) + G_2(s)$$
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            2つの伝達関数を並列に接続すると、全体の伝達関数は各伝達関数の和になります。
                        </p>
                    </div>

                    <div class="step">
                        <span class="step-number">3</span>
                        <strong>フィードバック結合 (Feedback Connection):</strong>
                        <div class="math-output">
                            $$G(s) = \frac{G_1(s)}{1 + G_1(s) \cdot G_2(s)}$$
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            負帰還（フィードバック）結合では、G₁が前向き伝達関数、G₂が帰還伝達関数です。
                        </p>
                    </div>

                    <div class="step">
                        <strong>計算例:</strong>
                        <table>
                            <thead>
                                <tr>
                                    <th>結合タイプ</th>
                                    <th>G₁(s)</th>
                                    <th>G₂(s)</th>
                                    <th>合成 G(s)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>直列</td>
                                    <td><span class="math-inline">\frac{1}{s+1}</span></td>
                                    <td><span class="math-inline">\frac{2}{s+2}</span></td>
                                    <td><span class="math-inline">\frac{2}{(s+1)(s+2)}</span></td>
                                </tr>
                                <tr>
                                    <td>並列</td>
                                    <td><span class="math-inline">\frac{1}{s+1}</span></td>
                                    <td><span class="math-inline">\frac{2}{s+2}</span></td>
                                    <td><span class="math-inline">\frac{3s+4}{(s+1)(s+2)}</span></td>
                                </tr>
                                <tr>
                                    <td>フィードバック</td>
                                    <td><span class="math-inline">\frac{K}{s}</span></td>
                                    <td><span class="math-inline">1</span></td>
                                    <td><span class="math-inline">\frac{K}{s+K}</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let poleZeroChart = null;
        let responseChart = null;
        let poles = [];
        let zeros = [];

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ]
            });
        }

        // Initialize pole-zero plot
        function initPoleZeroPlot() {
            const ctx = document.getElementById('poleZeroPlot').getContext('2d');

            if (poleZeroChart) {
                poleZeroChart.destroy();
            }

            poleZeroChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '極 (Poles)',
                            data: poles,
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            pointStyle: 'cross',
                            pointRadius: 10,
                            pointHoverRadius: 12
                        },
                        {
                            label: '零点 (Zeros)',
                            data: zeros,
                            backgroundColor: 'rgba(33, 150, 243, 0.8)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            pointStyle: 'circle',
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 's平面上の極零点配置 (Pole-Zero Plot)',
                            font: { size: 18 }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'center',
                            title: {
                                display: true,
                                text: '実軸 (Real Axis)',
                                font: { size: 14 }
                            },
                            min: -5,
                            max: 2,
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.5)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'center',
                            title: {
                                display: true,
                                text: '虚軸 (Imaginary Axis)',
                                font: { size: 14 }
                            },
                            min: -5,
                            max: 5,
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.5)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update transfer function
        function updateTransferFunction() {
            const tfType = document.getElementById('tf-select').value;
            const container = document.getElementById('tf-parameters');

            let html = '';

            switch(tfType) {
                case 'first-order':
                    html = `
                        <div class="input-field">
                            <label>ゲイン K:</label>
                            <input type="number" id="param-K" value="1" step="0.1">
                        </div>
                        <div class="input-field">
                            <label>時定数 τ:</label>
                            <input type="number" id="param-tau" value="1" step="0.1" min="0.1">
                        </div>
                    `;
                    break;

                case 'second-order':
                    html = `
                        <div class="input-field">
                            <label>固有角周波数 ω<sub>n</sub>:</label>
                            <input type="number" id="param-wn" value="2" step="0.1" min="0.1">
                        </div>
                        <div class="input-field">
                            <label>減衰係数 ζ:</label>
                            <input type="number" id="param-zeta" value="0.5" step="0.1" min="0">
                        </div>
                    `;
                    break;

                case 'integrator':
                    html = `
                        <div class="input-field">
                            <label>ゲイン K:</label>
                            <input type="number" id="param-K" value="1" step="0.1">
                        </div>
                    `;
                    break;

                case 'with-zero':
                    html = `
                        <div class="input-field">
                            <label>固有角周波数 ω<sub>n</sub>:</label>
                            <input type="number" id="param-wn" value="2" step="0.1" min="0.1">
                        </div>
                        <div class="input-field">
                            <label>減衰係数 ζ:</label>
                            <input type="number" id="param-zeta" value="0.5" step="0.1" min="0">
                        </div>
                        <div class="input-field">
                            <label>零点位置 z:</label>
                            <input type="number" id="param-zero" value="-1" step="0.1">
                        </div>
                    `;
                    break;

                case 'double-pole':
                    html = `
                        <div class="input-field">
                            <label>極の位置 p:</label>
                            <input type="number" id="param-pole" value="-1" step="0.1">
                        </div>
                    `;
                    break;

                case 'complex-poles':
                    html = `
                        <div class="input-field">
                            <label>実部 σ:</label>
                            <input type="number" id="param-sigma" value="-1" step="0.1">
                        </div>
                        <div class="input-field">
                            <label>虚部 ω:</label>
                            <input type="number" id="param-omega" value="2" step="0.1">
                        </div>
                    `;
                    break;
            }

            container.innerHTML = html;
        }

        // Plot pole-zero
        function plotPoleZero() {
            const tfType = document.getElementById('tf-select').value;
            poles = [];
            zeros = [];

            let tfString = '';

            switch(tfType) {
                case 'first-order':
                    const K = parseFloat(document.getElementById('param-K').value);
                    const tau = parseFloat(document.getElementById('param-tau').value);
                    poles.push({ x: -1/tau, y: 0 });
                    tfString = `G(s) = \\frac{${K}}{${tau}s + 1}`;
                    break;

                case 'second-order':
                    const wn = parseFloat(document.getElementById('param-wn').value);
                    const zeta = parseFloat(document.getElementById('param-zeta').value);
                    const sigma = -zeta * wn;
                    const wd = wn * Math.sqrt(1 - zeta * zeta);

                    if (zeta < 1) {
                        poles.push({ x: sigma, y: wd });
                        poles.push({ x: sigma, y: -wd });
                    } else if (zeta === 1) {
                        poles.push({ x: sigma, y: 0 });
                    } else {
                        const p1 = -zeta * wn + wn * Math.sqrt(zeta * zeta - 1);
                        const p2 = -zeta * wn - wn * Math.sqrt(zeta * zeta - 1);
                        poles.push({ x: p1, y: 0 });
                        poles.push({ x: p2, y: 0 });
                    }
                    tfString = `G(s) = \\frac{${wn * wn}}{s^2 + ${2 * zeta * wn}s + ${wn * wn}}`;
                    break;

                case 'integrator':
                    const Ki = parseFloat(document.getElementById('param-K').value);
                    poles.push({ x: 0, y: 0 });
                    tfString = `G(s) = \\frac{${Ki}}{s}`;
                    break;

                case 'with-zero':
                    const wn2 = parseFloat(document.getElementById('param-wn').value);
                    const zeta2 = parseFloat(document.getElementById('param-zeta').value);
                    const zero = parseFloat(document.getElementById('param-zero').value);
                    const sigma2 = -zeta2 * wn2;
                    const wd2 = wn2 * Math.sqrt(1 - zeta2 * zeta2);

                    zeros.push({ x: zero, y: 0 });
                    poles.push({ x: sigma2, y: wd2 });
                    poles.push({ x: sigma2, y: -wd2 });
                    tfString = `G(s) = \\frac{s - (${zero})}{s^2 + ${2 * zeta2 * wn2}s + ${wn2 * wn2}}`;
                    break;

                case 'double-pole':
                    const p = parseFloat(document.getElementById('param-pole').value);
                    poles.push({ x: p, y: 0 });
                    poles.push({ x: p, y: 0.1 }); // Slight offset for visibility
                    tfString = `G(s) = \\frac{1}{(s - (${p}))^2}`;
                    break;

                case 'complex-poles':
                    const sig = parseFloat(document.getElementById('param-sigma').value);
                    const omg = parseFloat(document.getElementById('param-omega').value);
                    poles.push({ x: sig, y: omg });
                    poles.push({ x: sig, y: -omg });
                    tfString = `G(s) = \\frac{1}{(s - (${sig} + j${omg}))(s - (${sig} - j${omg}))}`;
                    break;
            }

            initPoleZeroPlot();

            const output = document.getElementById('tf-output');
            output.innerHTML = '<span id="tf-display"></span>';
            katex.render(tfString, document.getElementById('tf-display'), { displayMode: true });
        }

        // Clear pole-zero plot
        function clearPoleZero() {
            poles = [];
            zeros = [];
            initPoleZeroPlot();
            document.getElementById('tf-output').innerHTML = '<p>伝達関数を選択してプロットしてください</p>';
        }

        // Update system parameters for response
        function updateSystemParameters() {
            const sysType = document.getElementById('system-select').value;
            const container = document.getElementById('system-parameters');

            let html = '';

            switch(sysType) {
                case 'first-order':
                    html = `
                        <div class="input-field">
                            <label>ゲイン K:</label>
                            <input type="number" id="sys-K" value="1" step="0.1">
                        </div>
                        <div class="input-field">
                            <label>時定数 τ:</label>
                            <input type="number" id="sys-tau" value="1" step="0.1" min="0.1">
                        </div>
                    `;
                    break;

                case 'second-order-underdamped':
                    html = `
                        <div class="input-field">
                            <label>固有角周波数 ω<sub>n</sub>:</label>
                            <input type="number" id="sys-wn" value="2" step="0.1" min="0.1">
                        </div>
                        <div class="input-field">
                            <label>減衰係数 ζ (0 < ζ < 1):</label>
                            <input type="number" id="sys-zeta" value="0.3" step="0.1" min="0.01" max="0.99">
                        </div>
                    `;
                    break;

                case 'second-order-critical':
                    html = `
                        <div class="input-field">
                            <label>固有角周波数 ω<sub>n</sub>:</label>
                            <input type="number" id="sys-wn" value="2" step="0.1" min="0.1">
                        </div>
                        <p style="color: #666;">減衰係数 ζ = 1 (臨界制動)</p>
                    `;
                    break;

                case 'second-order-overdamped':
                    html = `
                        <div class="input-field">
                            <label>固有角周波数 ω<sub>n</sub>:</label>
                            <input type="number" id="sys-wn" value="2" step="0.1" min="0.1">
                        </div>
                        <div class="input-field">
                            <label>減衰係数 ζ (ζ > 1):</label>
                            <input type="number" id="sys-zeta" value="2" step="0.1" min="1.01">
                        </div>
                    `;
                    break;
            }

            container.innerHTML = html;
        }

        // Calculate response
        function calculateResponse() {
            const responseType = document.getElementById('response-type').value;
            const sysType = document.getElementById('system-select').value;

            const t = [];
            const y = [];
            const dt = 0.01;
            const tMax = 10;

            for (let time = 0; time <= tMax; time += dt) {
                t.push(time);
                let value = 0;

                if (sysType === 'first-order') {
                    const K = parseFloat(document.getElementById('sys-K').value);
                    const tau = parseFloat(document.getElementById('sys-tau').value);

                    if (responseType === 'step') {
                        value = K * (1 - Math.exp(-time / tau));
                    } else {
                        value = (K / tau) * Math.exp(-time / tau);
                    }
                } else if (sysType.startsWith('second-order')) {
                    const wn = parseFloat(document.getElementById('sys-wn').value);
                    let zeta;

                    if (sysType === 'second-order-critical') {
                        zeta = 1;
                    } else {
                        zeta = parseFloat(document.getElementById('sys-zeta').value);
                    }

                    if (responseType === 'step') {
                        if (zeta < 1) {
                            const wd = wn * Math.sqrt(1 - zeta * zeta);
                            const phi = Math.atan(Math.sqrt(1 - zeta * zeta) / zeta);
                            value = 1 - (Math.exp(-zeta * wn * time) / Math.sqrt(1 - zeta * zeta)) *
                                    Math.sin(wd * time + phi);
                        } else if (zeta === 1) {
                            value = 1 - Math.exp(-wn * time) * (1 + wn * time);
                        } else {
                            const s1 = -zeta * wn + wn * Math.sqrt(zeta * zeta - 1);
                            const s2 = -zeta * wn - wn * Math.sqrt(zeta * zeta - 1);
                            value = 1 + (s1 * Math.exp(s2 * time) - s2 * Math.exp(s1 * time)) / (s1 - s2);
                        }
                    } else {
                        if (zeta < 1) {
                            const wd = wn * Math.sqrt(1 - zeta * zeta);
                            value = (wn / Math.sqrt(1 - zeta * zeta)) * Math.exp(-zeta * wn * time) *
                                    Math.sin(wd * time);
                        } else {
                            value = wn * wn * time * Math.exp(-wn * time);
                        }
                    }
                }

                y.push(value);
            }

            plotResponse(t, y, responseType);
        }

        // Plot response
        function plotResponse(t, y, responseType) {
            const ctx = document.getElementById('responseChart').getContext('2d');

            if (responseChart) {
                responseChart.destroy();
            }

            const data = t.map((time, i) => ({ x: time, y: y[i] }));

            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: responseType === 'step' ? 'ステップ応答' : 'インパルス応答',
                        data: data,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: responseType === 'step' ? 'ステップ応答' : 'インパルス応答',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '時間 t [s]'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '出力 y(t)'
                            }
                        }
                    }
                }
            });
        }

        // Show specifications
        function showSpecifications() {
            const sysType = document.getElementById('system-select').value;
            const container = document.getElementById('specs-content');
            const output = document.getElementById('specs-output');

            let specs = '';

            if (sysType === 'first-order') {
                const tau = parseFloat(document.getElementById('sys-tau').value);
                specs = `
                    <p><strong>時定数 τ:</strong> ${tau.toFixed(3)} s</p>
                    <p><strong>立ち上がり時間 (近似):</strong> ${(2.2 * tau).toFixed(3)} s</p>
                    <p><strong>整定時間 (2%):</strong> ${(4 * tau).toFixed(3)} s</p>
                `;
            } else if (sysType.startsWith('second-order')) {
                const wn = parseFloat(document.getElementById('sys-wn').value);
                const zeta = sysType === 'second-order-critical' ? 1 :
                            parseFloat(document.getElementById('sys-zeta').value);

                if (zeta < 1) {
                    const wd = wn * Math.sqrt(1 - zeta * zeta);
                    const Mp = Math.exp(-Math.PI * zeta / Math.sqrt(1 - zeta * zeta)) * 100;
                    const tp = Math.PI / wd;
                    const ts = 4 / (zeta * wn);

                    specs = `
                        <p><strong>減衰固有角周波数 ω<sub>d</sub>:</strong> ${wd.toFixed(3)} rad/s</p>
                        <p><strong>オーバーシュート M<sub>p</sub>:</strong> ${Mp.toFixed(1)}%</p>
                        <p><strong>ピーク時間 t<sub>p</sub>:</strong> ${tp.toFixed(3)} s</p>
                        <p><strong>整定時間 t<sub>s</sub> (2%):</strong> ${ts.toFixed(3)} s</p>
                    `;
                } else {
                    const ts = 4 / (zeta * wn);
                    specs = `
                        <p><strong>整定時間 t<sub>s</sub> (2%):</strong> ${ts.toFixed(3)} s</p>
                        <p><strong>オーバーシュート:</strong> なし（非振動）</p>
                    `;
                }
            }

            container.innerHTML = specs;
            output.style.display = 'block';
        }

        // Block Diagram Calculator functions
        function updateConnectionInputs() {
            const connType = document.getElementById('connection-type').value;
            const container = document.getElementById('block-inputs');

            let html = '';

            if (connType === 'series') {
                html = `
                    <div class="input-field">
                        <label>G₁の分子 (例: 1 または 2*s+3):</label>
                        <input type="text" id="g1-num" value="1" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₁の分母 (例: s+1 または s^2+2*s+1):</label>
                        <input type="text" id="g1-den" value="s+1" placeholder="分母の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂の分子:</label>
                        <input type="text" id="g2-num" value="2" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂の分母:</label>
                        <input type="text" id="g2-den" value="s+2" placeholder="分母の係数">
                    </div>
                `;
            } else if (connType === 'parallel') {
                html = `
                    <div class="input-field">
                        <label>G₁の分子 (例: 1 または 2*s+3):</label>
                        <input type="text" id="g1-num" value="1" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₁の分母 (例: s+1 または s^2+2*s+1):</label>
                        <input type="text" id="g1-den" value="s+1" placeholder="分母の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂の分子:</label>
                        <input type="text" id="g2-num" value="2" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂の分母:</label>
                        <input type="text" id="g2-den" value="s+2" placeholder="分母の係数">
                    </div>
                `;
            } else if (connType === 'feedback') {
                html = `
                    <div class="input-field">
                        <label>G₁（前向き）の分子:</label>
                        <input type="text" id="g1-num" value="K" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₁（前向き）の分母:</label>
                        <input type="text" id="g1-den" value="s" placeholder="分母の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂（帰還）の分子:</label>
                        <input type="text" id="g2-num" value="1" placeholder="分子の係数">
                    </div>
                    <div class="input-field">
                        <label>G₂（帰還）の分母:</label>
                        <input type="text" id="g2-den" value="1" placeholder="分母の係数">
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        /**
         * Sanitize user input for LaTeX formulas
         * Only allows: numbers, 's', operators, parentheses, dots
         * Prevents XSS attacks by rejecting HTML/JS special characters
         */
        function sanitizeLatexInput(input) {
            // Remove all HTML/JS special characters
            const cleaned = input.trim().replace(/[<>"'`]/g, '');

            // Only allow LaTeX math characters: numbers, s, operators, parentheses, dots, spaces
            const latexPattern = /^[0-9s\^\*\+\-\/\(\)\.\s]+$/;

            if (!cleaned || !latexPattern.test(cleaned)) {
                throw new Error('入力に無効な文字が含まれています。使用可能: 0-9, s, +, -, *, /, ^, (, ), .');
            }

            return cleaned;
        }

        function calculateBlockDiagram() {
            const connType = document.getElementById('connection-type').value;
            const output = document.getElementById('block-output');

            try {
                // Sanitize all user inputs to prevent XSS
                const g1Num = sanitizeLatexInput(document.getElementById('g1-num').value);
                const g1Den = sanitizeLatexInput(document.getElementById('g1-den').value);
                const g2Num = sanitizeLatexInput(document.getElementById('g2-num').value);
                const g2Den = sanitizeLatexInput(document.getElementById('g2-den').value);

                let resultHtml = '';
                let formula = '';

                resultHtml = '<div class="step-container">';

                resultHtml += '<div class="step">';
                resultHtml += '<strong>入力された伝達関数:</strong><br>';
                resultHtml += '<div class="math-output" style="margin: 15px 0;">';
                resultHtml += '<span id="g1-display"></span>';
                resultHtml += '</div>';
                resultHtml += '<div class="math-output" style="margin: 15px 0;">';
                resultHtml += '<span id="g2-display"></span>';
                resultHtml += '</div>';
                resultHtml += '</div>';

                resultHtml += '<div class="step">';
                resultHtml += '<strong>結合則:</strong><br>';
                resultHtml += '<div class="math-output" style="margin: 15px 0;">';
                resultHtml += '<span id="rule-display"></span>';
                resultHtml += '</div>';
                resultHtml += '</div>';

                resultHtml += '<div class="step">';
                resultHtml += '<strong>合成伝達関数:</strong><br>';
                resultHtml += '<div class="math-output" style="margin: 15px 0;">';
                resultHtml += '<span id="result-display"></span>';
                resultHtml += '</div>';
                resultHtml += '</div>';

                let resultNum = '';
                let resultDen = '';

                if (connType === 'series') {
                    resultNum = `(${g1Num}) \\cdot (${g2Num})`;
                    resultDen = `(${g1Den}) \\cdot (${g2Den})`;
                    formula = 'G(s) = G_1(s) \\cdot G_2(s)';
                } else if (connType === 'parallel') {
                    resultNum = `(${g1Num})(${g2Den}) + (${g2Num})(${g1Den})`;
                    resultDen = `(${g1Den}) \\cdot (${g2Den})`;
                    formula = 'G(s) = G_1(s) + G_2(s)';
                } else if (connType === 'feedback') {
                    resultNum = `(${g1Num}) \\cdot (${g2Den})`;
                    resultDen = `(${g1Den})(${g2Den}) + (${g1Num})(${g2Num})`;
                    formula = 'G(s) = \\frac{G_1(s)}{1 + G_1(s) \\cdot G_2(s)}';
                }

                resultHtml += '</div>';

                output.innerHTML = resultHtml;

                setTimeout(() => {
                    const g1Formula = `G_1(s) = \\frac{${g1Num}}{${g1Den}}`;
                    const g2Formula = `G_2(s) = \\frac{${g2Num}}{${g2Den}}`;
                    const resultFormula = `G(s) = \\frac{${resultNum}}{${resultDen}}`;

                    katex.render(g1Formula, document.getElementById('g1-display'), { displayMode: true });
                    katex.render(g2Formula, document.getElementById('g2-display'), { displayMode: true });
                    katex.render(formula, document.getElementById('rule-display'), { displayMode: true });
                    katex.render(resultFormula, document.getElementById('result-display'), { displayMode: true });
                }, 100);

            } catch (error) {
                output.innerHTML = '<div class="error-message">エラー: ' + error.message + '</div>';
            }
        }

        function clearBlockDiagram() {
            document.getElementById('block-output').innerHTML = '<p>結合タイプを選択して伝達関数を入力してください。</p>';
            updateConnectionInputs();
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            initPoleZeroPlot();
            updateTransferFunction();
            updateSystemParameters();
            updateConnectionInputs();

            setTimeout(() => {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ]
                });
            }, 500);
        });
    </script>
</body>
</html>
